###########################################################
# Package: Door Locks
###########################################################

homeassistant:
  customize:
    lock.lock_front_locked:
      friendly_name: Front Door
      extra_data_template: >
        ${entities['sensor.lock_front_status'].state}
      extra_badge:
        entity_id: sensor.lock_front_battery_level
        unit: "%"
      icon_template: >
        {% if is_state('sensor.lock_front_alarm_type', '19') %}
          mdi:account-key
        {% elif is_state('sensor.lock_front_alarm_type', '18') %}
          mdi:lock-smart
        {% elif is_state('sensor.lock_front_alarm_type', '21') %}
          mdi:lock
        {% elif is_state('sensor.lock_front_alarm_type', '22') %}
          mdi:lock-open
        {% elif is_state('sensor.lock_front_alarm_type', '24') %}
          mdi:wifi-strength-4-lock
        {% elif is_state('sensor.lock_front_alarm_type', '25') %}
          mdi:wifi
        {% elif is_state('sensor.lock_front_alarm_type', '9') %}
          mdi:lock-reset
        {% elif is_state('sensor.lock_front_alarm_type', '161') %}
          mdi:lock-alert
        {% elif states('lock.lock_front_locked') == "locked" %}
          mdi:lock
        {% elif states('lock.lock_front_locked') == "unlocked" %}
          mdi:lock-open
        {% else %}
          mdi:lock-question
        {% endif %}

  customize_glob:
    "zwave.lock_*":
      icon: mdi:lock-smart

    # Apply Custom UI
    "lock.lock_*_locked":
      custom_ui_state_card: state-card-custom-ui
      confirm_controls_show_lock: true

    # Set icons
    "input_boolean.door_keypad_*_switch":
      icon: mdi:lock-smart
    "input_text.door_keypad_*_code":
      icon: mdi:textbox-password
    "input_select.door_keypad_*_access_schedule":
      icon: mdi:calendar-clock
    "input_datetime.door_keypad_*_date_start":
      icon: mdi:clock-start
    "input_datetime.door_keypad_*_date_end":
      icon: mdi:clock-end

    # Hide unneeded lock sensors
    "sensor.lock_*_access_control":
      hidden: true
    "sensor.lock_*_alarm_level":
      hidden: true
    "sensor.lock_*_alarm_type":
      hidden: true
    "sensor.lock_*_power_management":
      hidden: true
    "sensor.lock_*_sourcenodeid":
      hidden: true
    "sensor.lock_*_system":
      hidden: true

    # Hide Scripts from Frontend
    "script.door_keypad_*_delete":
      hidden: true

history:
  exclude:
    entities:
      - input_text.door_keypad_1_name
      - input_text.door_keypad_1_code
      - input_select.door_keypad_1_access_schedule
      - input_datetime.door_keypad_1_date_start
      - input_datetime.door_keypad_1_date_end
      - input_boolean.door_keypad_1_front_switch
      - input_boolean.door_keypad_1_front_switch
      - sensor.keypad_1_temp_lock_turn_on
      - sensor.keypad_1_temp_lock_turn_off

      - input_text.door_keypad_2_name
      - input_text.door_keypad_2_code
      - input_select.door_keypad_2_access_schedule
      - input_datetime.door_keypad_2_date_start
      - input_datetime.door_keypad_2_date_end
      - input_boolean.door_keypad_2_front_switch
      - sensor.keypad_2_temp_lock_turn_on
      - sensor.keypad_2_temp_lock_turn_off

      - input_text.door_keypad_3_name
      - input_text.door_keypad_3_code
      - input_select.door_keypad_3_access_schedule
      - input_datetime.door_keypad_3_date_start
      - input_datetime.door_keypad_3_date_end
      - input_boolean.door_keypad_3_front_switch
      - sensor.keypad_3_temp_lock_turn_on
      - sensor.keypad_3_temp_lock_turn_off

      - input_text.door_keypad_4_name
      - input_text.door_keypad_4_code
      - input_select.door_keypad_4_access_schedule
      - input_datetime.door_keypad_4_date_start
      - input_datetime.door_keypad_4_date_end
      - input_boolean.door_keypad_4_front_switch
      - sensor.keypad_4_temp_lock_turn_on
      - sensor.keypad_4_temp_lock_turn_off

      - input_text.door_keypad_5_name
      - input_text.door_keypad_5_code
      - input_select.door_keypad_5_access_schedule
      - input_datetime.door_keypad_5_date_start
      - input_datetime.door_keypad_5_date_end
      - input_boolean.door_keypad_5_front_switch
      - sensor.keypad_5_temp_lock_turn_on
      - sensor.keypad_5_temp_lock_turn_off

      - input_text.door_keypad_6_name
      - input_text.door_keypad_6_code
      - input_select.door_keypad_6_access_schedule
      - input_datetime.door_keypad_6_date_start
      - input_datetime.door_keypad_6_date_end
      - input_boolean.door_keypad_6_front_switch
      - sensor.keypad_6_temp_lock_turn_on
      - sensor.keypad_6_temp_lock_turn_off

      - input_text.door_keypad_7_name
      - input_text.door_keypad_7_code
      - input_select.door_keypad_7_access_schedule
      - input_datetime.door_keypad_7_date_start
      - input_datetime.door_keypad_7_date_end
      - input_boolean.door_keypad_7_front_switch
      - sensor.keypad_7_temp_lock_turn_on
      - sensor.keypad_7_temp_lock_turn_off

      - input_text.door_keypad_8_name
      - input_text.door_keypad_8_code
      - input_select.door_keypad_8_access_schedule
      - input_datetime.door_keypad_8_date_start
      - input_datetime.door_keypad_8_date_end
      - input_boolean.door_keypad_8_front_switch
      - sensor.keypad_8_temp_lock_turn_on
      - sensor.keypad_8_temp_lock_turn_off

      - input_text.door_keypad_9_name
      - input_text.door_keypad_9_code
      - input_select.door_keypad_9_access_schedule
      - input_datetime.door_keypad_9_date_start
      - input_datetime.door_keypad_9_date_end
      - input_boolean.door_keypad_9_front_switch
      - sensor.keypad_9_temp_lock_turn_on
      - sensor.keypad_9_temp_lock_turn_off

      - input_text.door_keypad_10_name
      - input_text.door_keypad_10_code
      - input_select.door_keypad_10_access_schedule
      - input_datetime.door_keypad_10_date_start
      - input_datetime.door_keypad_10_date_end
      - input_boolean.door_keypad_10_front_switch
      - sensor.keypad_10_temp_lock_turn_on
      - sensor.keypad_10_temp_lock_turn_off

recorder:
  exclude:
    entities:
    # - sensor.lock_front_access_control
    # - sensor.lock_front_alarm_level
    # - sensor.lock_front_alarm_type
    - sensor.lock_front_power_management
    - sensor.lock_front_sourcenodeid
    - sensor.lock_front_system

influxdb:
  exclude:
    entities:
    # - sensor.lock_front_access_control
    # - sensor.lock_front_alarm_level
    # - sensor.lock_front_alarm_type
    - sensor.lock_front_power_management
    - sensor.lock_front_sourcenodeid
    - sensor.lock_front_system

group:
  keypads_view:
    name: Entry Codes
    view: yes
    icon: mdi:dialpad
    entities:
      - group.door_keypad_1
      - group.door_keypad_2
      - group.door_keypad_3
      - group.door_keypad_4
      - group.door_keypad_5
      - group.door_keypad_6
      - group.door_keypad_7
      - group.door_keypad_8
      - group.door_keypad_9
      - group.door_keypad_10

  locks:
    name: Locks
    entities:
      - lock.lock_front_locked
      # - sensor.lock_front_status

  door_keypad_1:
    control: hidden
    name: Entry Code 1
    entities:
      - input_text.door_keypad_1_name
      - input_text.door_keypad_1_code
      - input_select.door_keypad_1_access_schedule
      - input_datetime.door_keypad_1_date_start
      - input_datetime.door_keypad_1_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_1_front_switch
  door_keypad_2:
    control: hidden
    name: Entry Code 2
    entities:
      - input_text.door_keypad_2_name
      - input_text.door_keypad_2_code
      - input_select.door_keypad_2_access_schedule
      - input_datetime.door_keypad_2_date_start
      - input_datetime.door_keypad_2_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_2_front_switch
  door_keypad_3:
    control: hidden
    name: Entry Code 3
    entities:
      - input_text.door_keypad_3_name
      - input_text.door_keypad_3_code
      - input_select.door_keypad_3_access_schedule
      - input_datetime.door_keypad_3_date_start
      - input_datetime.door_keypad_3_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_3_front_switch
  door_keypad_4:
    control: hidden
    name: Entry Code 4
    entities:
      - input_text.door_keypad_4_name
      - input_text.door_keypad_4_code
      - input_select.door_keypad_4_access_schedule
      - input_datetime.door_keypad_4_date_start
      - input_datetime.door_keypad_4_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_4_front_switch
  door_keypad_5:
    control: hidden
    name: Entry Code 5
    entities:
      - input_text.door_keypad_5_name
      - input_text.door_keypad_5_code
      - input_select.door_keypad_5_access_schedule
      - input_datetime.door_keypad_5_date_start
      - input_datetime.door_keypad_5_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_5_front_switch
  door_keypad_6:
    control: hidden
    name: Entry Code 6
    entities:
      - input_text.door_keypad_6_name
      - input_text.door_keypad_6_code
      - input_select.door_keypad_6_access_schedule
      - input_datetime.door_keypad_6_date_start
      - input_datetime.door_keypad_6_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_6_front_switch
  door_keypad_7:
    control: hidden
    name: Entry Code 7
    entities:
      - input_text.door_keypad_7_name
      - input_text.door_keypad_7_code
      - input_select.door_keypad_7_access_schedule
      - input_datetime.door_keypad_7_date_start
      - input_datetime.door_keypad_7_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_7_front_switch
  door_keypad_8:
    control: hidden
    name: Entry Code 8
    entities:
      - input_text.door_keypad_8_name
      - input_text.door_keypad_8_code
      - input_select.door_keypad_8_access_schedule
      - input_datetime.door_keypad_8_date_start
      - input_datetime.door_keypad_8_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_8_front_switch
  door_keypad_9:
    control: hidden
    name: Entry Code 9
    entities:
      - input_text.door_keypad_9_name
      - input_text.door_keypad_9_code
      - input_select.door_keypad_9_access_schedule
      - input_datetime.door_keypad_9_date_start
      - input_datetime.door_keypad_9_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_9_front_switch
  door_keypad_10:
    control: hidden
    name: Entry Code 10
    entities:
      - input_text.door_keypad_10_name
      - input_text.door_keypad_10_code
      - input_select.door_keypad_10_access_schedule
      - input_datetime.door_keypad_10_date_start
      - input_datetime.door_keypad_10_date_end
      - sensor.hline_1
      - input_boolean.door_keypad_10_front_switch

script:
  lock_front_door_after_unlock:
    alias: Lock Front Door After Unlock
    sequence:
      - delay: '00:02:00'
      - service: lock.lock
        data:
          entity_id: lock.lock_front_locked

  door_keypad_1_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_1_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_1_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_1_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_1_front_switch

  door_keypad_2_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_2_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_2_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_2_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_2_front_switch

  door_keypad_3_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_3_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_3_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_3_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_3_front_switch

  door_keypad_4_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_4_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_4_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_4_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_4_front_switch

  door_keypad_5_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_5_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_5_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_5_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_5_front_switch

  door_keypad_6_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_6_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_6_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_6_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_6_front_switch

  door_keypad_7_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_7_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_7_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_7_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_7_front_switch

  door_keypad_8_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_8_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_8_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_8_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_8_front_switch

  door_keypad_9_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_9_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_9_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_9_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_9_front_switch

  door_keypad_10_delete:
    alias: Delete
    sequence:
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_10_name
    - service: input_text.set_value
      data:
        value: ''
        entity_id: input_text.door_keypad_10_code
    - service: input_select.select_option
      data:
        option: 'Always'
        entity_id: input_select.door_keypad_10_access_schedule
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.door_keypad_10_front_switch

sensor:
  - platform: template
    sensors:
      lock_front_status:
        friendly_name: Front Door Status
        value_template: >-
          {% if is_state('sensor.lock_front_alarm_type', '19') %}
            {% set code_slot = states('sensor.lock_front_alarm_level') %}
            {% set name_input = 'door_keypad_' ~ code_slot ~ '_name' %}
            {% set name = states['input_text'][name_input].state %}
            {% if name in ['unknown', ''] %}
              Unlocked with user code {{ code_slot }}
            {% else %}
              Unlocked by {{ name }}
            {% endif %}
          {% elif is_state('sensor.lock_front_alarm_type', '18') %}
            Keypad Lock
          {% elif is_state('sensor.lock_front_alarm_type', '21') %}
            Manual Lock
          {% elif is_state('sensor.lock_front_alarm_type', '22') %}
            Manual Unlock
          {% elif is_state('sensor.lock_front_alarm_type', '24') %}
            Remote Lock
          {% elif is_state('sensor.lock_front_alarm_type', '25') %}
            Remote Unlock
          {% elif is_state('sensor.lock_front_alarm_type', '9') %}
            Lock Jammed
          {% elif is_state('sensor.lock_front_alarm_type', '161') %}
            Tamper Alarm
          {% elif states('lock.lock_front_locked') == "locked" %}
            Locked
          {% elif states('lock.lock_front_locked') == "unlocked" %}
            Unlocked
          {% else %}
            Unknown
          {% endif %}

      keypad_1_temp_lock_turn_on:
        friendly_name: Turn keypad 1 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_1_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_1_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_2_temp_lock_turn_on:
        friendly_name: Turn keypad 2 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_2_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_2_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_3_temp_lock_turn_on:
        friendly_name: Turn keypad 3 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_3_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_3_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_4_temp_lock_turn_on:
        friendly_name: Turn keypad 4 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_4_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_4_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_5_temp_lock_turn_on:
        friendly_name: Turn keypad 5 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_5_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_5_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_6_temp_lock_turn_on:
        friendly_name: Turn keypad 6 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_6_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_6_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_7_temp_lock_turn_on:
        friendly_name: Turn keypad 7 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_7_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_7_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_8_temp_lock_turn_on:
        friendly_name: Turn keypad 8 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_8_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_8_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_9_temp_lock_turn_on:
        friendly_name: Turn keypad 9 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_9_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_9_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_10_temp_lock_turn_on:
        friendly_name: Turn keypad 10 on
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_10_date_start'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_10_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_1_temp_lock_turn_off:
        friendly_name: Turn keypad 1 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_1_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_1_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_2_temp_lock_turn_off:
        friendly_name: Turn keypad 2 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_2_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_2_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_3_temp_lock_turn_off:
        friendly_name: Turn keypad 3 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_3_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_3_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_4_temp_lock_turn_off:
        friendly_name: Turn keypad 4 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_4_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_4_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_5_temp_lock_turn_off:
        friendly_name: Turn keypad 5 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_5_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_5_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_6_temp_lock_turn_off:
        friendly_name: Turn keypad 6 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_6_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_6_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_7_temp_lock_turn_off:
        friendly_name: Turn keypad 7 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_7_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_7_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_8_temp_lock_turn_off:
        friendly_name: Turn keypad 8 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_8_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_8_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_9_temp_lock_turn_off:
        friendly_name: Turn keypad 9 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_9_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_9_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

      keypad_10_temp_lock_turn_off:
        friendly_name: Turn keypad 10 off
        entity_id: sensor.date__time
        value_template: >-
          {% set input = states['input_datetime']['door_keypad_10_date_end'] %}
          {% set time_now = states['sensor']['date__time'].state | replace(',', '') ~ ':00' %}
          {% set access_schedule = states['input_select']['door_keypad_10_access_schedule'].state %}
          {{ (access_schedule in ['Temporary', 'Recurring']) and input.state == time_now }}

input_text:
  door_keypad_1_name:
    name: Name
  door_keypad_1_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_2_name:
    name: Name
  door_keypad_2_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_3_name:
    name: Name
  door_keypad_3_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_4_name:
    name: Name
  door_keypad_4_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_5_name:
    name: Name
  door_keypad_5_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_6_name:
    name: Name
  door_keypad_6_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_7_name:
    name: Name
  door_keypad_7_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_8_name:
    name: Name
  door_keypad_8_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_9_name:
    name: Name
  door_keypad_9_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4
  door_keypad_10_name:
    name: Name
  door_keypad_10_code:
    name: Code
    pattern: '[0-9]*'
    min: 4
    max: 4

input_select:
  door_keypad_1_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_2_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_3_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_4_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_5_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_6_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_7_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_8_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_9_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time
  door_keypad_10_access_schedule:
    name: Access Schedule
    options:
      - Always
      - Recurring
      - Temporary
      - One Time

input_datetime:
  door_keypad_1_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_1_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_2_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_2_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_3_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_3_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_4_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_4_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_5_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_5_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_6_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_6_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_7_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_7_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_8_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_8_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_9_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_9_date_end:
    name: End Time
    has_date: true
    has_time: true
  door_keypad_10_date_start:
    name: Start Time
    has_date: true
    has_time: true
  door_keypad_10_date_end:
    name: End Time
    has_date: true
    has_time: true

input_boolean:
  door_keypad_1_front_switch:
    name: Front Door
  door_keypad_2_front_switch:
    name: Front Door
  door_keypad_3_front_switch:
    name: Front Door
  door_keypad_4_front_switch:
    name: Front Door
  door_keypad_5_front_switch:
    name: Front Door
  door_keypad_6_front_switch:
    name: Front Door
  door_keypad_7_front_switch:
    name: Front Door
  door_keypad_8_front_switch:
    name: Front Door
  door_keypad_9_front_switch:
    name: Front Door
  door_keypad_10_front_switch:
    name: Front Door

automation:
  - alias: "[Lock] Front Door Lock at Night"
    trigger:
      - platform: time
        at: "22:00:00"
    condition:
      - condition: state
        entity_id: lock.lock_front_locked
        state: "unlocked"
    action:
      - service: lock.lock
        entity_id: lock.lock_front_locked

  - alias: "[Lock] Front Door was Locked"
    trigger:
      - platform: state
        entity_id: lock.lock_front_locked
        to: "locked"
    action:
      - service: script.turn_off
        entity_id: script.lock_front_door_after_unlock

  - alias: "[Lock] Front Door was Unlocked"
    trigger:
      - platform: state
        entity_id: lock.lock_front_locked
        to: "unlocked"
    condition:
      - condition: time
        after: "22:00:00"
        before: "09:00:00"
    action:
      - service: script.turn_on
        entity_id: script.lock_front_door_after_unlock

  - alias: "[Lock] Front Door Lock when Away"
    trigger:
      - platform: state
        entity_id: group.people
        to: "not_home"
    condition:
      - condition: time
        after: "09:00:00"
        before: "22:00:00"
      - condition: state
        entity_id: lock.lock_front_locked
        state: "unlocked"
    action:
      - service: lock.lock
        entity_id: lock.lock_front_locked
      - service: notify.join_users
        data_template:
          title: Front Door Lock
          message: "The front door has been locked since no one is home."
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/lock.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"

  - alias: "[Lock] Keypad Switch On"
    hide_entity: true
    trigger:
      - platform: state
        entity_id:
          - input_boolean.door_keypad_1_front_switch
          - input_boolean.door_keypad_2_front_switch
          - input_boolean.door_keypad_3_front_switch
          - input_boolean.door_keypad_4_front_switch
          - input_boolean.door_keypad_5_front_switch
          - input_boolean.door_keypad_6_front_switch
          - input_boolean.door_keypad_7_front_switch
          - input_boolean.door_keypad_8_front_switch
          - input_boolean.door_keypad_9_front_switch
          - input_boolean.door_keypad_10_front_switch
        to: "on"
    condition:
      - condition: template
        value_template: >-
          {% set object_id = trigger.to_state.object_id %}
          {% set code_slot = '_'.join(object_id.split('_')[2:-2]) %}
          {% set select_id = 'door_keypad_' ~ code_slot ~ '_access_schedule' %}
          {{ states['input_select'][select_id].state == 'Always' }}
    action:
      - service: lock.set_usercode
        data_template:
          node_id: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set lock_name = '_'.join(object_id.split('_')[3:-1]) %}
            {% set lock_id = 'lock_' ~ lock_name ~ '_locked' %}
            {{ states['lock'][lock_id].attributes.node_id }}
          code_slot: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = '_'.join(object_id.split('_')[2:-2]) %}
            {{ code_slot }}
          usercode: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = '_'.join(object_id.split('_')[2:-2]) %}
            {% set user_code_id = 'door_keypad_' ~ code_slot ~ '_code' %}
            {{ states['input_text'][user_code_id].state }}

  - alias: "[Lock] Keypad Switch Off"
    hide_entity: true
    trigger:
      - platform: state
        to: "off"
        entity_id:
          - input_boolean.door_keypad_1_front_switch
          - input_boolean.door_keypad_2_front_switch
          - input_boolean.door_keypad_3_front_switch
          - input_boolean.door_keypad_4_front_switch
          - input_boolean.door_keypad_5_front_switch
          - input_boolean.door_keypad_6_front_switch
          - input_boolean.door_keypad_7_front_switch
          - input_boolean.door_keypad_8_front_switch
          - input_boolean.door_keypad_9_front_switch
          - input_boolean.door_keypad_10_front_switch
    condition:
      - condition: template
        value_template: >-
          {% set object_id = trigger.to_state.object_id %}
          {% set code_slot = '_'.join(object_id.split('_')[2:-2]) %}
          {% set select_id = 'door_keypad_' ~ code_slot ~ '_access_schedule' %}
          {{ states['input_select'][select_id].state == 'Always' }}
    action:
      - service: lock.set_usercode
        data_template:
          usercode: >-
            {{ range(1000, 9999) | random }}
          node_id: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set lock_name = '_'.join(object_id.split('_')[3:-1]) %}
            {% set lock_id = 'lock_' ~ lock_name ~ '_locked' %}
            {{ states['lock'][lock_id].attributes.node_id }}
          code_slot: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = '_'.join(object_id.split('_')[2:-2]) %}
            {{ code_slot }}

  - alias: "[Lock] Keypad Temporary Code Start"
    hide_entity: true
    trigger:
      - platform: state
        to: "True"
        entity_id:
          - sensor.keypad_1_temp_lock_turn_on
          - sensor.keypad_2_temp_lock_turn_on
          - sensor.keypad_3_temp_lock_turn_on
          - sensor.keypad_4_temp_lock_turn_on
          - sensor.keypad_5_temp_lock_turn_on
          - sensor.keypad_6_temp_lock_turn_on
          - sensor.keypad_7_temp_lock_turn_on
          - sensor.keypad_8_temp_lock_turn_on
          - sensor.keypad_9_temp_lock_turn_on
          - sensor.keypad_10_temp_lock_turn_on
    condition:
      - condition: template
        value_template: >-
          {% set object_id = trigger.to_state.object_id %}
          {% set code_slot = object_id[7:-18] %}
          {% set input = 'door_keypad_' ~ code_slot ~ '_front_switch' %}
          {{ states['input_boolean'][input].state == 'on' }}
    action:
      - service: lock.set_usercode
        data_template:
          usercode: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-18] %}
            {% set input = 'door_keypad_' ~ code_slot ~ '_code' %}
            {{ states['input_text'][input].state }}
          node_id: >-
            {{ states['lock']['lock_front_locked'].attributes.node_id }}
          code_slot: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-18] %}
            {{ code_slot }}
      - service: notify.join_users
        data_template:
          title: "Temporary Code Enabled"
          message: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-18] %}
            {% set usercode_input = 'door_keypad_' ~ code_slot ~ '_code' %}
            {% set usercode = states['input_text'][usercode_input].state %}
            {% set name_input = 'door_keypad_' ~ code_slot ~ '_name' %}
            {% set name = states['input_text'][name_input].state %}
            {% set start_input = 'door_keypad_' ~ code_slot ~ '_date_start' %}
            {% set start = states['input_datetime'][start_input].state %}
            {% set end_input = 'door_keypad_' ~ code_slot ~ '_date_end' %}
            {% set end = states['input_datetime'][end_input].state %}
            The pin code {{ usercode }} is now temporarily enabled for {{ name }} from {{ start }} to {{ end }}.
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/lock-smart.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"

  - alias: "[Lock] Keypad Temporary Code End"
    hide_entity: true
    trigger:
      - platform: state
        to: "True"
        entity_id:
          - sensor.keypad_1_temp_lock_turn_off
          - sensor.keypad_2_temp_lock_turn_off
          - sensor.keypad_3_temp_lock_turn_off
          - sensor.keypad_4_temp_lock_turn_off
          - sensor.keypad_5_temp_lock_turn_off
          - sensor.keypad_6_temp_lock_turn_off
          - sensor.keypad_7_temp_lock_turn_off
          - sensor.keypad_8_temp_lock_turn_off
          - sensor.keypad_9_temp_lock_turn_off
          - sensor.keypad_10_temp_lock_turn_off
    action:
      - service: lock.set_usercode
        data_template:
          usercode: >-
            {{ range(1000, 9999) | random }}
          node_id: >-
            {{ states['lock']['lock_front_locked'].attributes.node_id }}
          code_slot: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-19] %}
            {{ code_slot }}
      - service: notify.join_users
        data_template:
          title: "Temporary Code Disabled"
          message: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-19] %}
            {% set usercode_input = 'door_keypad_' ~ code_slot ~ '_code' %}
            {% set usercode = states['input_text'][usercode_input].state %}
            {% set name_input = 'door_keypad_' ~ code_slot ~ '_name' %}
            {% set name = states['input_text'][name_input].state %}
            The pin code {{ usercode }} for {{ name }} has now been removed.
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/lock-smart.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"
      - condition: template
        value_template: >-
          {% set object_id = trigger.to_state.object_id %}
          {% set code_slot = object_id[7:-19] %}
          {% set input = 'door_keypad_' ~ code_slot ~ '_access_schedule' %}
          {% set input_value = states['input_select'][input].state %}
          {{ input_value == 'Temporary' }}
      - service: script.turn_on
        data_template:
          entity_id: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-19] %}
            {{ 'script.door_keypad_' ~ code_slot ~ '_delete' }}

  - alias: "[Lock] Keypad One Time Use Code"
    hide_entity: true
    trigger:
      - platform: state
        entity_id: lock.lock_front_locked
        to: "unlocked"
    condition:
      - condition: template
        value_template: >-
          {% set object_id = trigger.to_state.object_id %}
          {% set code_slot = object_id[7:-19] %}
          {% set input = 'door_keypad_' ~ code_slot ~ '_access_schedule' %}
          {% set input_value = states['input_select'][input].state %}
          {{ input_value == 'One Time' }}
    action:
      - service: lock.set_usercode
        data_template:
          usercode: >-
            {{ range(1000, 9999) | random }}
          node_id: >-
            {{ states['lock']['lock_front_locked'].attributes.node_id }}
          code_slot: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-19] %}
            {{ code_slot }}
      - service: notify.join_users
        data_template:
          title: "One Time Use Code Used"
          message: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-19] %}
            {% set usercode_input = 'door_keypad_' ~ code_slot ~ '_code' %}
            {% set usercode = states['input_text'][usercode_input].state %}
            {% set name_input = 'door_keypad_' ~ code_slot ~ '_name' %}
            {% set name = states['input_text'][name_input].state %}
            The pin code {{ usercode }} for {{ name }} has now been used and removed.
          data:
            icon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/lock-smart.png"
            smallicon: "https://raw.githubusercontent.com/zanix/home-assistant-config/master/www/icons/home-assistant.png"
      - condition: template
        value_template: >-
          {% set object_id = trigger.to_state.object_id %}
          {% set code_slot = object_id[7:-19] %}
          {% set input = 'door_keypad_' ~ code_slot ~ '_access_schedule' %}
          {% set input_value = states['input_select'][input].state %}
          {{ input_value == 'One Time' }}
      - service: script.turn_on
        data_template:
          entity_id: >-
            {% set object_id = trigger.to_state.object_id %}
            {% set code_slot = object_id[7:-19] %}
            {{ 'script.door_keypad_' ~ code_slot ~ '_delete' }}
